# -*- mode: org -*-
# -*- coding: utf-8 -*-
#+STARTUP: overview indent inlineimages logdrawer
#+startup: beamer
#+LINK_HOME:
#+TITLE: Matrix factorization methods for association mapping
#+AUTHOR:    Kevin Caye$^{1}$, Olivier Michel$^{2}$, Olivier Francois$^{1}$
#+BEAMER_HEADER: \institute{$^{1}$ TIMC-IMAG, $^{2}$ GIPSA-lab}
#+EMAIL:     kevin.caye@imag.fr
#+DATE:      2017-01-06  
#+OPTIONS: H:2 toc:t num:t
#+LATEX_CLASS: beamer
#+BEAMER_THEME: default
#+BEAMER_FRAME_LEVEL: 2
#+DESCRIPTION: 
#+KEYWORDS: 
#+LANGUAGE:  en
#+BEAMER_HEADER: \input{../../../MaThese/notations.tex}
#+LATEX_HEADER: \input{header}
#+PROPERTY: header-args    :exports none
#  LocalWords:  dataset Celiac Genotypic SNP RidgeLFMM LassoLFMM LFMM genotype
#  LocalWords:  methylation

* Introduction

** Dataset
:LOGBOOK:
- Note taken on [2017-06-02 ven. 12:29] \\
  data et exemple de EWAS !
:END:

#+begin_src R :results output 
  G <- readRDS("~/Projects/Thesis/Data/ThesisDataset/3Article/GSE42861/G.rds")
  dim(G)
  G[1:4, 1:4]
#+end_src

#+RESULTS:
#+begin_example
  [1]    689 162038
             cg00000029 cg00000165 cg00000236  cg00000289
  GSM1051525   2.570601  0.9992794  0.5671318 -0.82059475
  GSM1051526   1.402888  0.6278198  0.6574943  0.01820761
  GSM1051527   1.417139  0.7503816  1.0295372  0.76304748
  GSM1051528   1.338992  1.7947700  0.8489499  0.59589792
#+end_example

*Dataset*
- $\Y$ output observed matrix
- $\X$ primary variables matrix.
  

*Example*
- Association of DNA methylation with Rheumatoid Arthritis (RA) cite:Liu_2013
  - $\Y$ records DNA methylation level for $\Yrow = 689$ at $\Ycol = 162~038$
    sites
  - $\X$ records RA disease state for each individual.

*** COMMENT celiac
- Association of genotype with Celiac disease cite:dubois2010multiple
  - $\Y$ records genotype for $\Yrow = 15~155$ individuals at
    $\Ycol = 281 112$ loci.
  - $\X$ records Celiac disease state for each individual


** Goal
*We want* to detect output variables which are in relationship with the primary
interest variable.

*Why*
- Data mining (identify interesting variable for further study)
- Personalized medicine (Polygenic Risk Score).

** Multiple Hypothesis Testing: Simple Linear Regression
   
 Linear model supposes that
     $$\Y =  \X \B^{T} + \E$$
   where
      - $\B$ is the primary effect matrix
      - $\E$ is the residual error matrix.
   
   We want to detect $j$ output variable where we can reject the hypothesis 
   
   $$ H_0: \B_j = 0.$$

*** COMMENT zscore
   We compute z-score for each locus $j$: 
   
   $$ z_j = \frac{\hat{B_j}}{\hat{\sigma_j}} $$

   where $\hat{\B_j}$ is an estimation of $\B_j$ and $\hat{\sigma_j}$ the
   estimation its standard deviation.

** DONE Example: Linear Regression on Rheumatoid Arthritis Dataset 
CLOSED: [2017-06-21 mer. 14:59]
:LOGBOOK:
- Note taken on [2017-06-05 Mon 12:51] \\
  on voit pas la legende .
- Note taken on [2017-06-05 Mon 12:50] \\
  faut que j'enleve pvalue et lm
:END:

#+begin_src R
  expr <- retrieveExperiment(110)
  pl <- MethodBatchExperiment_qqplot(expr)
  save_plot_timc_bcm_15(pl, "GSE42861_qqplot_lm.png", path.dir = "~/Projects/Thesis/These/Slides/JourneePersyvalLab/Rplots/")
#+end_src

#+CAPTION: Q-Q plot of significance $t$ test for the linear regression.
[[./Rplots/GSE42861_qqplot_lm.png]]

*** COMMENT comments
There is *unwanded variation* which we want to detect and remove. 

** Example: Principal Component Analysis of Rheumatoid Arthritis dataset 
#+begin_src R :results output 
  library(ThesisRpackage)

  dat <- Article3_GSE42861_sampler() %>% sampl()

  ## K = 2 svd
  svd2 <- svd(dat$G, 10, 10)

  ## dump
  expr <- Experiment(name = "10 svd on RA")
  expr$description <- "10 svd on ~/Projects/Thesis/Data/ThesisDataset/3Article/GSE42861/G.rds"
  expr$svd2 <- svd2
  dumpExperiment(expr)

#+end_src

#+begin_src R :results output 
  library(ThesisRpackage)

  expr <- retrieveExperiment(138)


  ## indiv info
  X <- readRDS("~/Projects/Thesis/Data/ThesisDataset/3Article/GSE42861/X.rds")
  X.cor <- cor(cbind(expr$svd2$u[,1:2], X))[1:2, -c(1,2)]
  X.cor
  toplot.X.cor <- tibble(x = X.cor[1,], y = X.cor[2,], covariates = as.character(colnames(X.cor)))
  toplot.X.cor

  ## plot
  toplot <- as_tibble(expr$svd2$u) %>%
    mutate(`score PC1` = V1, `score PC2` = V2)
  pl <- ggplot(toplot, aes(`score PC1`, `score PC2`)) +
    geom_point() +
    geom_segment(data = toplot.X.cor, aes(xend = x,
                                          yend = y,
                                          color = covariates),
                 x = 0, y = 0
               , arrow=arrow(length=unit(0.3,"cm"))) 
    ## geom_text(data = toplot.X.cor, aes(color = covariable,
    ##                                    x = toplot.X.cor$x,
    ##                                    y = toplot.X.cor$y,
    ##                                    label = toplot.X.cor$covariable), hjust = -0.4)

  pl

  save_plot_timc_bcm_15(pl, filename = "PC_RA.png", path.dir = "~/Projects/Thesis/These/Slides/JourneePersyvalLab/Rplots/")
#+end_src

#+CAPTION: PCA of the RA dataset DNA methylation level matrix. 
[[./Rplots/PC_RA.png]]

*** COMMENT comments
In DNA methylation dataset there are unobserved variables which can be
confounding for association the primary variable (Age, gender, smoking status,
cellular composition).

* Latent Factor in Multiple Hypothesis Testing
** Latent Factor Mixed Model
Following the common notation in *latent factor mixed model* (LFMM) we write the following
model cite:wang2015confounder,frichot13_testin_assoc_between_loci_envir

\begin{equation}
\label{eq:model}
\Y = \X \B^T + \U \V^T + \E 
\end{equation}

- $\U \V^{T}$ is the unwanted variation
- $\X \B^{T}$ is the variation of interest
- $\E$ the residual noise.

** Estimation
*L2-norm loss function*
\begin{equation*}
\label{eq:optim_no_reg}
\LfmmL
\end{equation*}
*Identifiability problem:* $L$ does not allow to separate source of unwanted variation from
interested variation citep:wang2015confounder.
\begin{equation*}
L(\U, \V, \B) = L(\U - \X \matr{C}, \V, \B + \V \matr{C}^{T})
\end{equation*}
** Regularized Estimation

*Ridge* regularized LFMM

\begin{equation*}
\LfmmLridge
\end{equation*}

*Lasso* regularized LFMM

\begin{equation*}
L_{lasso}(\matr{W}, \B) =  \frac{1}{2} \norm{\Y - \matr{W} - \X \B^T}_{F}^2 + \lambda \norm{\B}_{1} + \gamma \norm{\matr{W}}_{*}
\end{equation*}

where $$\matr{W} = \U \V^{T}.$$

** COMMENT Ridge regularized LFMM (RidgeLFMM)

*Solutions* of optimization of the ridge regularized loss function

\begin{align*}
\hat{\U} \hat{\V} & =  \sqrt{\obP}^{-1} * svd_{\K}(\sqrt{\obP} \Y ) \\
\hat{\B} & = (\X^{T} \X + \lambda \Id_{d})^{-1} \X^{T} (G - \hat{\U} \hat{\V}),
\end{align*}

where 

\begin{equation*}
\obP = \sqrt{\obP}^{2}.
\end{equation*}

** COMMENT Lasso regularized LFMM (LassoLFMM)

The lasso regularized loss function is *convex* of $\C$ and $\B$, we can alternated minimization
along each variable

- compute $\B_{t}$ as minimizing the loss function
\begin{equation}
\label{eq:lasso_algo_1}
L_{lasso}^{1}(\B) =  \frac{1}{2} ||(\Y - \C_{t-1}) - \X \B^T||_{F}^2 + \lambda ||\B||_1
\end{equation}

- compute $\C_{t}$ as minimizing the loss function
\begin{equation}
\label{eq:lasso_algo_2}
L_{lasso}^{2}(\C) = \frac{1}{2} ||(\Y - \X \B_t^T)- \C ||_{F}^2 + \gamma ||\C||_{*}.
\end{equation}

* Some Results of Association Mapping
** COMMENT Numerical validation
We performed simulations of LFMM generative model $$\Y = \X \B^T + \U \V^T + \E$$ 

with $$ B_{j} \neq 0$$ for some variables associated with the variable of
interest $\X$.

With correlation between latent factor matrix score $\U$ and $\X$.

** COMMENT Numerical validation
:LOGBOOK:
- Note taken on [2017-06-05 Mon 13:14] \\
  changer le nom des axes
- Note taken on [2017-06-05 Mon 13:11] \\
  il faut des legende plus clair en haut et sur le cotÃ© .
- Note taken on [2017-06-02 ven. 17:05] \\
  je suis pas content du plot, il y a moyen de plus planter l'acp !!!
:END:

#+begin_src R :results output 
  library(ThesisRpackage)

  s <- NormalSampler2(n = 100,
                      L = 1000,
                      K = 3,
                      prop.outlier = NULL)

  methods <- list()
  methods$lfmm.ridge <- finalLfmmRdigeMethod(K = 3, lambda = 1e-5)
  methods$lfmm.lasso <- finalLfmmLassoMethod(K = 3, 0.1)
  methods$lmPca <- finalPcaLm(K = 3)
  methods$lm <- finalLm()

  ## TODO pass s in parameter
  expr <- Article3_MethodComparison(G.file = NULL,
                                    outlier.props = c(0.1),
                                    cs = c(0.9, 0.6, 0.3),
                                    s = s,
                                    methods = methods,
                                    nb.rep = 4,
                                    cluster.nb = 4)

  pl <- Article3_MethodComparison_plot_precisionRecall(expr)
  pl
  save_plot_timc_bcm_15(pl, "method_comp.png", path.dir = "~/Projects/Thesis/These/Slides/JourneePersyvalLab/Rplots/")
#+end_src


[[./Rplots/method_comp.png]]
#+CAPTION: TODO

** DONE Rheumatoid Arthritis dataset
CLOSED: [2019-06-21 ven. 14:59]

#+begin_src R 
  library(ThesisRpackage)
  expr <- retrieveExperiment(121)
  expr$description
  expr <- MethodBatchExperiment_calibrate(expr)
  expr$method.batch <- expr$method.batch[6]
  pl <- MethodBatchExperiment_qqplot(expr)
  save_plot_timc_bcm_15(pl, filename = "ra_qqplot.png",
                        path.dir = "~/Projects/Thesis/These/Slides/ThemasSeminar2017/Rplots/")
#+end_src

#+RESULTS:
#+begin_example
       pvalue1    method     id rank
1 1.571451e-11 RidgeLfmm  36714    1
2 2.471069e-11 RidgeLfmm 101455    2
3 1.325428e-10 RidgeLfmm  51546    3
4 2.246499e-08 RidgeLfmm 125220    4
5 1.085111e-07 RidgeLfmm 149131   12
#+end_example

#+CAPTION: Q-Q plot of significance $t$ test for the linear regression with latent variables computed with RidgeLFMM.
[[./Rplots/ra_qqplot.png]]

** Rheumatoid Arthritis dataset

If we control the number of false discovery to $5 \%$: 

- we retrieve main methylation probes found in other study using explicitly
  confounding variables (age, gender, smoking status, cellular composition)
  citep:Rahmani_2016

- and other candidates.

** Celiac Disease Dataset

Association of SNPs with Celiac disease citep:dubois2010multiple. 
- $\Y$ is the matrix of 281 122 SNPs for 15 155 individuals
- $\X$ is the matrix recording disease state for the 15 155 individuals

#+BEGIN_SRC R 
  G <- readRDS("~/Projects/Thesis/Data/ThesisDataset/3Article/Celiac/G.rds")
  dim(G)
#+END_SRC

#+RESULTS:
#+begin_example
  [1]  15155 281122
#+end_example

#+begin_src R :results output 
  library(ThesisRpackage)
  expr <- retrieveExperiment(131)
  expr$description
  expr <- MethodBatchExperiment_calibrate(expr)
#+end_src

#+begin_src R :results output 
  res <- MethodBatchExperiment_qvalue(expr, fdr.threshold = 0.05)
  pl <- ggplot(res, aes(x = index, y = -log10(pvalue), color = qvalue < 0.05)) +
    geom_point() +
    ggtitle("Manhattan plot")
  save_plot_timc_bcm_15(pl, filename = "celiac_man.png",
                        path.dir = "~/Projects/Thesis/These/Slides/ThemasSeminar2017/Rplots/")
#+end_src

** Celiac Disease Dataset

#+CAPTION: Manhattan plot of the $t$ test pvalue for le linear regression with latent variables computed with RidgeLFMM.
[[./Rplots/celiac_man.png]]

** Celiac Disease Dataset

#+begin_src R :results output 
  library(ThesisRpackage)
  expr <- retrieveExperiment(131)
  expr$description
  expr <- MethodBatchExperiment_calibrate(expr)
  cat("============= candidates with fdr < 0.05  \n")
  res <- MethodBatchExperiment_candidates(expr, fdr.threshold = 0.05, print = TRUE)
#+end_src

If we control the number of false discovery to $5 \%$: 

- we retrieve $73 \%$ of the SNPs associated with the Celiac disease according to GWAS
  catalog found with other dataset and other methods

- other candidates.


** Summary 

- We develop a new method to take into account confounding factors in association studies.
- Our method enables to control the number of false discoveries.
- We discovered new candidate loci (CpG sites and SNPs) associated with
  Rheumatoid Arthritis and Celiac disease.
- Methods which scale to big data.

Thank you for your attention ! 

** References
bibliography:../../../biblio.bib
bibliographystyle:apalike


** COMMENT Celiac dataset
We applied LfmmRidge on Celiac dataset.

We retrieve in top 1000 .... of SNP referenced in GWASCatalogue.

qqplot avec les annotations classic.
